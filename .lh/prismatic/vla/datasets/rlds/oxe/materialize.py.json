{
    "sourceFile": "prismatic/vla/datasets/rlds/oxe/materialize.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1765266663564,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1765266663564,
            "name": "Commit-0",
            "content": "\"\"\"\nmaterialize.py\n\nFactory class for initializing Open-X Embodiment dataset kwargs and other parameters; provides and exports functions for\nclear control flow.\n\"\"\"\n\nfrom copy import deepcopy\nfrom pathlib import Path\nfrom typing import Any, Dict, List, Tuple\n\nfrom prismatic.overwatch import initialize_overwatch\nfrom prismatic.vla.constants import ACTION_DIM, ACTION_PROPRIO_NORMALIZATION_TYPE, ACTION_TOKEN_BEGIN_IDX, IGNORE_INDEX, NUM_ACTIONS_CHUNK, PROPRIO_DIM, STOP_INDEX\nfrom prismatic.vla.datasets.rlds.oxe.configs import OXE_DATASET_CONFIGS, ActionEncoding\nfrom prismatic.vla.datasets.rlds.oxe.transforms import OXE_STANDARDIZATION_TRANSFORMS\n\n# Initialize Overwatch =>> Wraps `logging.Logger`\noverwatch = initialize_overwatch(__name__)\n\n\ndef make_oxe_dataset_kwargs(\n    dataset_name: str,\n    data_root_dir: Path,\n    load_camera_views: Tuple[str] = (\"primary\",),\n    load_depth: bool = False,\n    load_proprio: bool = True,\n    load_language: bool = True,\n    action_proprio_normalization_type = ACTION_PROPRIO_NORMALIZATION_TYPE,\n) -> Dict[str, Any]:\n    \"\"\"Generates config (kwargs) for given dataset from Open-X Embodiment.\"\"\"\n    dataset_kwargs = deepcopy(OXE_DATASET_CONFIGS[dataset_name])\n    if dataset_kwargs[\"action_encoding\"] not in [ActionEncoding.EEF_POS, ActionEncoding.EEF_R6, ActionEncoding.JOINT_POS_BIMANUAL]:\n        raise ValueError(f\"Cannot load `{dataset_name}`; only EEF_POS & EEF_R6 & JOINT_POS_BIMANUAL actions supported!\")\n\n    # [Contract] For EEF_POS & EEF_R6 actions, only the last action dimension (gripper) is absolute!\n    # Normalize all action dimensions *except* the gripper\n    if dataset_kwargs[\"action_encoding\"] is ActionEncoding.EEF_POS:\n        dataset_kwargs[\"absolute_action_mask\"] = [False] * 6 + [True]\n        dataset_kwargs[\"action_normalization_mask\"] = [True] * 6 + [False]\n    elif dataset_kwargs[\"action_encoding\"] is ActionEncoding.EEF_R6:\n        dataset_kwargs[\"absolute_action_mask\"] = [False] * 9 + [True]\n        dataset_kwargs[\"action_normalization_mask\"] = [True] * 9 + [False]\n    elif dataset_kwargs[\"action_encoding\"] is ActionEncoding.JOINT_POS_BIMANUAL:\n        dataset_kwargs[\"absolute_action_mask\"] = [True] * 14\n        dataset_kwargs[\"action_normalization_mask\"] = [True] * 14\n    dataset_kwargs[\"action_proprio_normalization_type\"] = action_proprio_normalization_type\n\n    # Adjust Loaded Camera Views\n    if len(missing_keys := (set(load_camera_views) - set(dataset_kwargs[\"image_obs_keys\"]))) > 0:\n        raise ValueError(f\"Cannot load `{dataset_name}`; missing camera views `{missing_keys}`\")\n\n    # Filter\n    dataset_kwargs[\"image_obs_keys\"] = {\n        k: v for k, v in dataset_kwargs[\"image_obs_keys\"].items() if k in load_camera_views\n    }\n    dataset_kwargs[\"depth_obs_keys\"] = {\n        k: v for k, v in dataset_kwargs[\"depth_obs_keys\"].items() if k in load_camera_views\n    }\n\n    # Eliminate Unnecessary Keys\n    dataset_kwargs.pop(\"state_encoding\")\n    dataset_kwargs.pop(\"action_encoding\")\n    if not load_depth:\n        dataset_kwargs.pop(\"depth_obs_keys\")\n    if not load_proprio:\n        dataset_kwargs.pop(\"state_obs_keys\")\n\n    # Load Language\n    if load_language:\n        dataset_kwargs[\"language_key\"] = \"language_instruction\"\n\n    # Specify Standardization Transform\n    dataset_kwargs[\"standardize_fn\"] = OXE_STANDARDIZATION_TRANSFORMS[dataset_name]\n\n    # Add any aux arguments\n    if \"aux_kwargs\" in dataset_kwargs:\n        dataset_kwargs.update(dataset_kwargs.pop(\"aux_kwargs\"))\n\n    return {\"name\": dataset_name, \"data_dir\": str(data_root_dir), **dataset_kwargs}\n\n\ndef get_oxe_dataset_kwargs_and_weights(\n    data_root_dir: Path,\n    mixture_spec: List[Tuple[str, float]],\n    load_camera_views: Tuple[str] = (\"primary\",),\n    load_depth: bool = False,\n    load_proprio: bool = True,\n    load_language: bool = True,\n    action_proprio_normalization_type = ACTION_PROPRIO_NORMALIZATION_TYPE,\n) -> Tuple[Dict[str, Any], List[float]]:\n    \"\"\"\n    Generates dataset kwargs for a given dataset mix from the Open X-Embodiment dataset. The returned kwargs\n    (per-dataset configs) and weights can be passed directly to `make_interleaved_dataset`.\n\n    :param data_root_dir: Base directory containing RLDS/TFDS-formatted datasets (from Open-X)\n    :param mixture_spec: List of (dataset_name, sampling_weight) from `oxe.mixtures.OXE_NAMED_MIXTURES`\n    :param load_camera_views: Camera views to load; see `oxe.dataset_configs.py` for available views.\n    :param load_depth: Load depth information in addition to camera RGB.\n    :param load_proprio: Load proprioceptive state.\n    :param load_language: Load language instructions.\n    :param action_proprio_normalization_type: Normalization scheme to use for proprioceptive actions.\n\n    return: Tuple of (per_dataset_kwargs, sampling_weights)\n    \"\"\"\n    included_datasets, filtered_mixture_spec = set(), []\n    for d_name, d_weight in mixture_spec:\n        if d_name in included_datasets:\n            overwatch.warning(f\"Skipping Duplicate Dataset: `{(d_name, d_weight)}`\")\n            continue\n\n        included_datasets.add(d_name)\n        filtered_mixture_spec.append((d_name, d_weight))\n\n    # Assemble Dataset Config (kwargs) and Weights\n    per_dataset_kwargs, sampling_weights = [], []\n    for d_name, d_weight in filtered_mixture_spec:\n        try:\n            per_dataset_kwargs.append(\n                make_oxe_dataset_kwargs(\n                    d_name,\n                    data_root_dir,\n                    load_camera_views,\n                    load_depth,\n                    load_proprio,\n                    load_language,\n                    action_proprio_normalization_type,\n                )\n            )\n            sampling_weights.append(d_weight)\n\n        except ValueError as e:\n            overwatch.warning(f\"Skipping `{d_name}` due to Error: {e}\")\n\n    return per_dataset_kwargs, sampling_weights\n"
        }
    ]
}